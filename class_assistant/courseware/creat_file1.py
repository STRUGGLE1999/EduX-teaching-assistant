import streamlit as st
import os
import time
from docx import Document
from docx.shared import Pt
from docx.oxml.ns import qn
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.shared import Pt
from docx.oxml.ns import qn
from class_assistant.courseware.localApp import generate_text_from_model
from class_assistant.courseware.extract_high_freq_words import extract_high_freq_words_from_file

doc = Document()


# æ·»åŠ wordä¸€çº§æ ‡é¢˜
def add_MainHeading(text):
    p = doc.add_paragraph()
    run = p.add_run(text)
    run.bold = True
    run.font.size = Pt(14)
    run.font.name = 'å®‹ä½“'
    run._element.rPr.rFonts.set(qn('w:eastAsia'), 'å®‹ä½“')


# æ·»åŠ wordæ­£æ–‡å†…å®¹
def add_body(text):
    content = (text)
    p = doc.add_paragraph(content)
    p.runs[0].font.size = Pt(12)
    p.runs[0].font.name = 'å®‹ä½“'
    p.runs[0]._element.rPr.rFonts.set(qn('w:eastAsia'), 'å®‹ä½“')


# åˆ›å»ºå¤§çº²wordæ–‡æ¡£
def create_file(course_name, course_alltime, course_labtime, course_sub, course_type, file):
    st.warning('æäº¤æˆåŠŸï¼Œæ•™å­¦å¤§çº²æ–‡æ¡£ç”Ÿæˆä¸­ï¼Œè¯·ç¨åã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # åˆ›å»ºä¸€ä¸ªæ–°çš„Wordæ–‡æ¡£

    st.warning('å¤§çº²è¯¾ç¨‹æ¦‚è¦éƒ¨åˆ†ç”Ÿæˆä¸­ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # æ·»åŠ wordæ ‡é¢˜ï¼Œå¹¶è®¾ç½®å­—ä½“ä¸ºå®‹ä½“
    title = doc.add_heading(course_name + 'è¯¾ç¨‹' + 'æ•™å­¦å¤§çº²', level=0)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER  # æ ‡é¢˜å±…ä¸­
    for run in title.runs:
        run.font.name = 'å®‹ä½“'
        run._element.rPr.rFonts.set(qn('w:eastAsia'), 'å®‹ä½“')
        run.bold = True  # æ ‡é¢˜åŠ ç²—

    prompt1 = "å°†" + course_name + "ç¿»è¯‘æˆè‹±è¯­ï¼Œåªè¾“å‡ºè‹±æ–‡ç»“æœå³å¯ï¼Œä¸è¦å…¶ä»–ä»»ä½•ç¬¦å·å’Œæè¿°"
    course_nameE = generate_text_from_model(prompt1)

    prompt2 = "è¾“å‡º" + course_name + "çš„å…ˆä¿®è¯¾ç¨‹ï¼Œ2-3é—¨é‡è¦çš„å³å¯ï¼Œåªè¾“å‡ºç»“æœï¼Œä¸è¦ä»»ä½•ç¬¦å·å’Œæè¿°"
    course_pre = generate_text_from_model(prompt2)

    # å®šä¹‰ä¿¡æ¯å­—æ®µå’Œå¯¹åº”çš„ç¤ºä¾‹æ•°æ®
    course_info = {
        'è¯¾ç¨‹åç§°': course_name,
        'è‹±æ–‡åç§°': course_nameE,
        'å­¦æ—¶': course_alltime,
        'å®éªŒå­¦æ—¶': course_labtime,
        'è¯¾ç¨‹æ€§è´¨': course_type,
        'é€‚ç”¨ä¸“ä¸š': course_sub,
        'å…ˆä¿®è¯¾ç¨‹': course_pre,
    }

    # æ·»åŠ ä¸€ä¸ªè¡¨æ ¼ï¼Œè¡¨æ ¼çš„è¡Œæ•°æ˜¯å­—æ®µæ•°ï¼Œåˆ—æ•°æ˜¯2
    table = doc.add_table(rows=len(course_info), cols=2)

    # è®¾ç½®è¡¨æ ¼æ ·å¼ï¼ˆå¯é€‰ï¼‰
    table.style = 'Table Grid'

    # å¡«å……ä¿¡æ¯å­—æ®µå’Œæ•°æ®
    for i, (field, value) in enumerate(course_info.items()):
        row_cells = table.rows[i].cells
        for idx, text in enumerate([field, value]):
            paragraph = row_cells[idx].paragraphs[0]
            run = paragraph.runs[0] if paragraph.runs else paragraph.add_run()
            run.text = text
            run.font.name = 'å®‹ä½“'
            run._element.rPr.rFonts.set(qn('w:eastAsia'), 'å®‹ä½“')
            if idx == 0:  # å­—æ®µååŠ ç²—
                run.bold = True
            run.font.size = Pt(12)

    st.success('å¤§çº²è¯¾ç¨‹æ¦‚è¦éƒ¨åˆ†ç”ŸæˆæˆåŠŸï¼')

    high_freq_words = extract_high_freq_words_from_file(file, 20)

    # æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
    doc.add_paragraph()

    st.warning('å¤§çº²è¯¾ç¨‹è¯´æ˜éƒ¨åˆ†ç”Ÿæˆä¸­ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # æ·»åŠ è¯¾ç¨‹è¯´æ˜æ ‡é¢˜
    add_MainHeading('ä¸€ã€è¯¾ç¨‹è¯´æ˜')

    prompt3 = "è¾“å‡º" + course_name + "è¿™ä¸€é—¨å¤§å­¦è¯¾ç¨‹çš„è¯¾ç¨‹è¯´æ˜ï¼Œè¯¾ç¨‹è¯´æ˜åˆ†ä¸ºä¸‰æ®µè¯ï¼Œæ¯æ®µ100å­—ï¼Œè¯¾ç¨‹ç±»å‹ä¸º" + course_type + ",é€‚ç”¨ä¸“ä¸šä¸º" + course_sub + """å…ˆç”¨ä¸€æ®µè¯ä»‹ç»è¯¾ç¨‹åŸºæœ¬å†…å®¹å’Œå­¦ç”ŸåŸ¹å…»ç›®æ ‡ï¼Œå†ç”¨ä¸€æ®µè¯ä»‹ç»è¯¾ç¨‹æ•™å­¦è®¾è®¡æ¦‚è¿°ï¼Œæœ€åç”¨ä¸€æ®µè¯è¯¾ç¨‹æ•™å­¦æ–¹æ³•æ¦‚è¿°ï¼Œ
        åªè¾“å‡ºä¸‰æ®µç»“æœå³å¯ï¼Œä¸è¦ä»»ä½•ç¬¦å·å’Œæè¿°ï¼Œä¸éœ€è¦å°æ ‡é¢˜ï¼Œæ®µä¸æ®µä¹‹é—´ä¸è¦ç©ºè¡Œï¼Œæ€»è®¡ä¸è¶…è¿‡300å­—ï¼Œ
        å›ç­”ä¸è¦å‡ºç°â€œç¬¬ä¸€æ®µï¼šâ€ç±»ä¼¼çš„æè¿°ï¼Œ
        ä»¥ä¸‹ä¸ºå¦ä¸€é—¨è¯¾ç¨‹çš„è¯¾ç¨‹è¯´æ˜ï¼Œä¾›å‚è€ƒ:
        æœ¬è¯¾ç¨‹è®²è§£ç³»ç»Ÿçš„åŸºæœ¬æ¶æ„ã€æœåŠ¡æ¨¡å¼å’Œå¼€å‘åŸç†ï¼Œè®©å­¦ç”Ÿå¯¹è®¡ç®—æœºç³»ç»Ÿçš„è®¤è¯†ä»å•æœºã€æœ¬åœ°ç³»ç»Ÿä¸Šå‡åˆ°äº‘ç³»ç»Ÿï¼Œé‡ç‚¹åŸ¹å…»å­¦ç”Ÿçš„æ€ç»´å’Œèƒ½åŠ›ã€‚æœ¬è¯¾ç¨‹ç†è®ºå’Œå®è·µå¹¶é‡ï¼Œè®©å­¦ç”Ÿåœ¨åº”ç”¨å’Œå¼€å‘è¿‡ç¨‹ä¸­ï¼ŒçœŸæ­£ç†è§£ç³»ç»Ÿçš„é­…åŠ›æ‰€åœ¨ã€‚
        åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œæ—¢é”»ç‚¼å­¦ç”Ÿæ­å»ºåº•å±‚èƒ½åŠ›ï¼Œåˆç€é‡åŸ¹å…»å­¦ç”Ÿå¼€å‘åº”ç”¨çš„èƒ½åŠ›ã€‚
        è¯¾ç¨‹æ˜¯ä¸€é—¨è¾ƒä¸ºå‰æ²¿ã€ç›¸å…³çŸ¥è¯†å’ŒæŠ€æœ¯éšç€å·¥ä¸šç•Œçš„å‘å±•ä¸æ–­æ¼”è¿›çš„è¯¾ç¨‹ï¼Œéœ€è¦å®æ—¶å…³æ³¨æœ€æ–°åŠ¨æ€ï¼Œå¹¶ç»“åˆå®é™…èå…¥åˆ°æ•™å­¦è¿‡ç¨‹ä¸­ï¼Œæœ€ç»ˆä½¿å¾—å­¦ç”Ÿåœ¨è¿›å…¥è¡Œä¸šå‰å°±å…·å¤‡åŸºæœ¬èƒ½åŠ›ã€‚
        """ + "æœ¬è¯¾ç¨‹" + course_name + f"ä¸­é¢‘ç¹å‡ºç°çš„å…³é”®è¯åŒ…æ‹¬{high_freq_words}ã€‚"
    course_anal = generate_text_from_model(prompt3)

    # æ·»åŠ è¯¾ç¨‹è¯´æ˜å†…å®¹
    add_body(course_anal)

    st.success('å¤§çº²è¯¾ç¨‹è¯´æ˜éƒ¨åˆ†ç”ŸæˆæˆåŠŸï¼')

    # æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
    doc.add_paragraph()

    st.warning('å¤§çº²è¯¾ç¨‹ç›®æ ‡éƒ¨åˆ†ç”Ÿæˆä¸­ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # æ·»åŠ è¯¾ç¨‹ç›®æ ‡æ ‡é¢˜
    add_MainHeading('äºŒã€è¯¾ç¨‹ç›®æ ‡')

    prompt4 = "è¾“å‡º" + course_name + "è¿™ä¸€é—¨å¤§å­¦è¯¾ç¨‹çš„è¯¾ç¨‹ç›®æ ‡ï¼Œåˆ†ä¸ºå››ä¸ªç‚¹ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ ¼å¼ï¼Œç›®æ ‡1ï¼šäº†è§£ä»€ä¹ˆå†…å®¹ï¼Œç›®æ ‡2ï¼šç†è§£ä»€ä¹ˆå†…å®¹ï¼Œç›®æ ‡3ï¼šæŒæ¡ä»€ä¹ˆå†…å®¹ï¼Œç›®æ ‡4ï¼šè¿ç”¨ä»€ä¹ˆå†…å®¹ï¼Œåªåˆ†å››æ®µè¾“å‡ºå››ä¸ªç›®æ ‡ï¼Œä¸è¦ä»»ä½•ç¬¦å·å’Œæè¿°"
    course_tar = generate_text_from_model(prompt4)

    # æ·»åŠ è¯¾ç¨‹ç›®æ ‡å†…å®¹
    add_body(course_tar)

    st.success('å¤§çº²è¯¾ç¨‹ç›®æ ‡éƒ¨åˆ†ç”ŸæˆæˆåŠŸï¼')

    # æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
    doc.add_paragraph()

    st.warning('å¤§çº²æ•™å­¦å†…å®¹ä¸å­¦æ—¶å®‰æ’éƒ¨åˆ†ç”Ÿæˆä¸­ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # æ·»åŠ æ•™å­¦å†…å®¹æ ‡é¢˜
    add_MainHeading('ä¸‰ã€æ•™å­¦å†…å®¹ä¸å­¦æ—¶å®‰æ’')

    prompt5 = "é€ä¸ªç« èŠ‚è®¾è®¡" + course_name + "è¿™ä¸€é—¨å¤§å­¦è¯¾ç¨‹çš„è¯¾ç¨‹å†…å®¹ï¼Œè¯¾ç¨‹ç±»å‹ä¸º" + course_type + ",é€‚ç”¨ä¸“ä¸šä¸º" + course_sub + "æ³¨æ„æ¯ç« çš„å­¦æ—¶ä¸€èˆ¬ä¸º2-4ï¼Œæ€»å’Œéœ€ç­‰äº" + course_alltime + "," + """
        ä¸€èˆ¬è®¾è®¡12ä¸ªç« èŠ‚å·¦å³ï¼Œæ¯ä¸€ç« çš„è®¾è®¡éƒ½éœ€ä½ é€ä¸€åˆ—å‡º
        ç« ä¸ç« ä¹‹é—´ç©ºä¸€è¡Œ,å…¶ä»–ä¸ç©ºè¡Œ,æŒ‰ç…§ä¸‹é¢çš„æ ¼å¼è¾“å‡º,ä¸è¦ä»»ä½•æè¿°
        ç¬¬XXXç« ï¼šXXX
        å­¦æ—¶ï¼šXXX
        å†…å®¹ï¼š1ã€XXXï¼›2ã€XXXï¼›3ã€XXX
        è¦æ±‚å­¦ç”Ÿï¼šXXX
        """ + "æœ¬è¯¾ç¨‹" + course_name + f"ä¸­é¢‘ç¹å‡ºç°çš„å…³é”®è¯åŒ…æ‹¬{high_freq_words}ã€‚"
    course_txt = generate_text_from_model(prompt5)

    # æ·»åŠ æ•™å­¦å†…å®¹
    add_body(course_txt)

    st.success('å¤§çº²æ•™å­¦å†…å®¹ä¸å­¦æ—¶å®‰æ’éƒ¨åˆ†ç”ŸæˆæˆåŠŸï¼')

    # æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
    doc.add_paragraph()

    st.warning('å¤§çº²æ•™å­¦æ–¹æ³•éƒ¨åˆ†ç”Ÿæˆä¸­ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # æ·»åŠ æ•™å­¦æ–¹æ³•æ ‡é¢˜
    add_MainHeading('å››ã€æ•™å­¦æ–¹æ³•')

    prompt6 = "è®¾è®¡" + course_name + "è¿™ä¸€é—¨å¤§å­¦è¯¾ç¨‹çš„æ•™å­¦æ–¹å¼ï¼Œä¸è¦ä»»ä½•ç¬¦å·å’Œæè¿°ï¼Œåªè¾“å‡ºç­”æ¡ˆï¼Œ200å­—ä»¥å†…ï¼Œå¯åˆ†æ®µä½†ä¸è¦åˆ†ç‚¹ï¼Œä¸éœ€è¦å°æ ‡é¢˜" + """
    ä»¥ä¸‹ä¸ºå¦ä¸€é—¨è¯¾ç¨‹è¯¾ç¨‹çš„æ•™å­¦æ–¹æ³•ï¼Œä¾›å‚è€ƒ:
    åœ¨ç»„ç»‡æ–¹å¼ä¸Šï¼Œè¯¾å‰å­¦ç”Ÿé€šè¿‡æå‰åˆ†å‘çš„è¯¾ä»¶ï¼Œé¢„ä¹ ç›¸å…³çŸ¥è¯†ï¼›è¯¾ä¸­åœ¨çº¿ä¸‹æ•™å®¤å¸®åŠ©å­¦ç”Ÿæ¢³ç†å’Œå·©å›ºçŸ¥è¯†ç‚¹ï¼Œå¹¶ä¸”ç€é‡è®²è§£é‡ç‚¹å’Œéš¾ç‚¹å†…å®¹ï¼›è¯¾åï¼Œå­¦ç”Ÿåœ¨å‰åŠå­¦æœŸå®Œæˆä¸€ç³»åˆ—ä¸Šæœºå®è·µï¼ŒååŠå­¦æœŸè¿ç”¨è¯¾ç¨‹æŠ€æœ¯æŠ€æœ¯å®Œæˆå¼€å‘é¡¹ç›®ã€‚è¯¾ç¨‹å°†ç»„ç»‡1æ¬¡ç†è®ºæµ‹éªŒå’Œ1æ¬¡é¡¹ç›®ç­”è¾©ï¼Œè¾¾åˆ°åˆæ ¼æ°´å¹³æ–¹èƒ½é€šè¿‡è€ƒæ ¸ã€‚
    å­¦ç”Ÿé€šè¿‡é¢„ä¹ å’Œçº¿ä¸‹è¯¾å ‚å­¦ä¹ ã€å·©å›ºç†è®ºçŸ¥è¯†ï¼Œé€šè¿‡è¿›è¡Œå¤§é‡ä¸Šæœºå®è·µé”»ç‚¼èƒ½åŠ›ï¼Œç£¨ç‚¼åˆ†æé—®é¢˜ã€è§£å†³é—®é¢˜çš„åŠ¨æ‰‹å®è·µèƒ½åŠ›ï¼Œå¹¶ä¸”åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¿›ä¸€æ­¥åŠ æ·±å¯¹äºç†è®ºçŸ¥è¯†çš„è®¤çŸ¥ï¼Œæœ€ç»ˆè¾¾åˆ°å¯¹äºè¯¾ç¨‹ â€œçŸ¥å…¶ç„¶å¹¶ä¸”çŸ¥å…¶æ‰€ä»¥ç„¶â€çš„å­¦ä¹ æ•ˆæœï¼Œä¸ºæ—¥åä»äº‹ç›¸å…³å·¥ä½œæ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚
    """
    course_teachway = generate_text_from_model(prompt6)

    # æ·»åŠ æ•™å­¦æ–¹æ³•å†…å®¹
    add_body(course_teachway)

    st.success('å¤§çº²æ•™å­¦æ–¹æ³•éƒ¨åˆ†ç”ŸæˆæˆåŠŸï¼')

    # æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
    doc.add_paragraph()

    st.warning('å¤§çº²è€ƒæ ¸æ–¹å¼éƒ¨åˆ†ç”Ÿæˆä¸­ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚')

    # æ·»åŠ è€ƒæ ¸æ–¹å¼æ ‡é¢˜
    add_MainHeading('äº”ã€è€ƒæ ¸æ–¹å¼')

    prompt7 = "è®¾è®¡" + course_name + "è¿™ä¸€é—¨å¤§å­¦è¯¾ç¨‹çš„è€ƒæ ¸æ–¹å¼ï¼Œä¸è¦ä»»ä½•ç¬¦å·å’Œæè¿°ï¼Œåªè¾“å‡ºç­”æ¡ˆï¼Œ200å­—å·¦å³ï¼Œå¯åˆ†æ®µä½†ä¸è¦åˆ†ç‚¹ï¼Œä¸éœ€è¦å°æ ‡é¢˜ã€‚" + """
    ä»¥ä¸‹ä¸ºå¦ä¸€é—¨è¯¾ç¨‹çš„è€ƒæ ¸æ–¹æ³•ï¼Œä¾›å‚è€ƒ:
    æœ¬è¯¾ç¨‹é‡‡ç”¨é—­å·å½¢å¼è¿›è¡Œè€ƒæ ¸ï¼Œå­¦ç”Ÿéœ€åœ¨è¯¾ç¨‹ç»“æŸæ—¶å®Œæˆä¸€ä»½é—­å·è€ƒè¯•ã€‚è€ƒè¯•å†…å®¹æ¶µç›–è¯¾ç¨‹ä¸­æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼ŒåŒ…æ‹¬ç†è®ºæ¦‚å¿µã€ç®—æ³•åŸç†ã€åº”ç”¨å®è·µç­‰ã€‚è€ƒè¯•æ—¶é—´ä¸º2å°æ—¶ã€‚
    è¯„ä»·å­¦ç”Ÿçš„æ–¹å¼åŒ…æ‹¬å¹³æ—¶ä½œä¸šã€å®éªŒæŠ¥å‘Šå’Œè¯¾å ‚è¡¨ç°ç­‰ã€‚å…¶ä¸­ï¼Œå¹³æ—¶ä½œä¸šåŒ…æ‹¬è¯¾å ‚è®²ä¹‰ã€ä¹ é¢˜ç»ƒä¹ å’Œä½œä¸šæ‰¹æ”¹ç­‰ï¼Œå æ€»æˆç»©çš„30%ï¼›å®éªŒæŠ¥å‘ŠåŒ…æ‹¬è¯¾ç¨‹è®¾è®¡æŠ¥å‘Šå’Œå®éªŒæŠ¥å‘Šç­‰ï¼Œå æ€»æˆç»©çš„20%ï¼›è¯¾å ‚è¡¨ç°åŒ…æ‹¬è¯¾å ‚æé—®ã€è®¨è®ºå’Œæ¼”è®²ç­‰ï¼Œå æ€»æˆç»©çš„10%ï¼›æœŸæœ«è€ƒæ ¸å æ€»æˆç»©çš„40%ã€‚
    """
    course_exam = generate_text_from_model(prompt7)

    # æ·»åŠ è€ƒæ ¸æ–¹å¼å†…å®¹
    add_body("æœ¬è¯¾ç¨‹æ—¨åœ¨åŸ¹å…»å­¦ç”Ÿçš„ç†è®ºç´ å…»ã€åŠ¨æ‰‹èƒ½åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚" + course_exam)

    st.success('å¤§çº²è€ƒæ ¸æ–¹å¼éƒ¨åˆ†ç”ŸæˆæˆåŠŸï¼')

    # ä¿å­˜æ–‡æ¡£
    os.makedirs('result', exist_ok=True)
    output_filename = f"{course_name}æ•™å­¦å¤§çº².docx"
    output_path = os.path.join('result', output_filename)
    doc.save(output_path)

    st.success('å¤§çº²æ•™å­¦å¤§çº²æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼')

    # ç”¨ä¸‹è½½æŒ‰é’®è®©ç”¨æˆ·ä¸‹è½½
    with open(output_path, "rb") as f:
        data = f.read()
    st.download_button(
        label="ğŸ“¥ ä¸‹è½½æ•™å­¦å¤§çº²",
        data=data,
        file_name=output_filename,
        mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    )

    time.sleep(1)

    
